{% extends 'base.html' %}

{% block extra_css %}
<style>
  .reports-shell { max-width:1100px; margin:0 auto; padding:1.25rem; }
  .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  @media (max-width:768px) { .charts-grid { grid-template-columns:1fr; } }
  .card { background: #0f1724; border:1px solid #263044; padding:1rem; border-radius:12px; color:#e6eef6; }
  .card h3 { font-size:1.05rem; margin-bottom:0.5rem; color:#cfeee8; }
  .chart-actions { display:flex; gap:0.5rem; align-items:center; margin-top:0.6rem; flex-wrap:wrap; }
  .btn { background:linear-gradient(135deg,#06b6d4,#2563eb); color:#022; padding:0.45rem 0.75rem; border-radius:999px; font-weight:700; border:none; cursor:pointer; }
  .btn.secondary { background:#334155; color:#fff; }
  .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  .summary-row { display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap; }
  .summary-item { background:#071427; padding:0.8rem 1rem; border-radius:8px; border:1px solid #203040; min-width:180px; }
  .summary-item .value { font-size:1.25rem; font-weight:700; margin-top:0.25rem; color:#e6f7f2; }
</style>
{% endblock %}

{% block content %}
<div class="reports-shell">
  <div class="mb-4">
    <h1 class="text-2xl font-bold text-white">Reports & Analytics</h1>
    <p class="text-slate-400">Period: <strong>{{ period|capfirst }}</strong> â€” starting {{ start_date|date:"M d, Y" }}</p>
  </div>

  <div class="summary-row" role="region" aria-label="Summary metrics">
    <div class="summary-item" role="article" aria-label="Total income">
      <div class="label">Total Income</div>
      <div class="value">${{ total_income }}</div>
    </div>
    <div class="summary-item" role="article" aria-label="Total expense">
      <div class="label">Total Expense</div>
      <div class="value">${{ total_expense }}</div>
    </div>
    <div class="summary-item" role="article" aria-label="Net profit">
      <div class="label">Net Profit</div>
      <div class="value">${{ net_profit }}</div>
    </div>
  </div>

  <div class="charts-grid" aria-live="polite">
    <div class="card" id="overview-card">
      <h3>Income vs Expenses</h3>
      <canvas id="overviewChart" aria-label="Income versus Expenses chart" role="img" height="160"></canvas>
      <div class="chart-actions">
        <button class="btn" id="export-overview-png">Export PNG</button>
        <button class="btn secondary" id="export-overview-pdf">Export PDF</button>
      </div>
    </div>

    <div class="card" id="expense-card">
      <h3>Top Expense Categories</h3>
      <canvas id="expensePie" aria-label="Top expense categories chart" role="img" height="160"></canvas>
      <div class="chart-actions">
        <button class="btn" id="export-expense-png">Export PNG</button>
        <button class="btn secondary" id="export-expense-pdf">Export PDF</button>
      </div>
    </div>

    <div class="card" style="grid-column:1 / -1;">
      <h3>Income by Category (Breakdown)</h3>
      <canvas id="incomeBar" aria-label="Income by category bar chart" role="img" height="160"></canvas>
      <div class="chart-actions">
        <button class="btn" id="export-income-png">Export PNG</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Parse JSON prepared by the view
  const overviewLabels = {{ overview_labels_json|default:"[]"|safe }};
  const overviewValues = {{ overview_values_json|default:"[]"|safe }};
  const expenseLabels = {{ expense_labels_json|default:"[]"|safe }};
  const expenseValues = {{ expense_values_json|default:"[]"|safe }};
  const incomeLabels = {{ income_labels_json|default:"[]"|safe }};
  const incomeValues = {{ income_values_json|default:"[]"|safe }};

  // Colors (accessible palette)
  const palette = ['#06b6d4','#06b6d4','#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4'];

  // Overview donut/bar showing Income vs Expenses
  const overviewCtx = document.getElementById('overviewChart').getContext('2d');
  const overviewChart = new Chart(overviewCtx, {
    type: 'doughnut',
    data: {
      labels: overviewLabels,
      datasets: [{ data: overviewValues, backgroundColor: ['#10b981','#ef4444'], hoverOffset: 8 }]
    },
    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ color:'#fff' } } } }
  });

  // Expense pie
  const expenseCtx = document.getElementById('expensePie').getContext('2d');
  const expenseChart = new Chart(expenseCtx, {
    type: 'pie',
    data: { labels: expenseLabels, datasets: [{ data: expenseValues, backgroundColor: palette, hoverOffset:8 }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ color:'#fff' } } } }
  });

  // Income bar
  const incomeCtx = document.getElementById('incomeBar').getContext('2d');
  const incomeChart = new Chart(incomeCtx, {
    type: 'bar',
    data: { labels: incomeLabels, datasets: [{ label: 'Income', data: incomeValues, backgroundColor: '#3b82f6' }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } },
      scales: { x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' }, beginAtZero:true } } }
  });

  // Export helpers
  function downloadPNG(chart, filename) {
    const link = document.createElement('a');
    link.href = chart.toBase64Image('image/png', 1);
    link.download = filename;
    link.click();
  }

  async function downloadPDF(chart, filename) {
    const { jsPDF } = window.jspdf;
    const imgData = chart.toBase64Image('image/png', 1);
    const doc = new jsPDF({ orientation:'landscape' });
    const width = doc.internal.pageSize.getWidth();
    const height = doc.internal.pageSize.getHeight();
    // keep aspect ratio
    doc.addImage(imgData, 'PNG', 8, 8, width - 16, height - 16);
    doc.save(filename);
  }

  // Wire export buttons
  document.getElementById('export-overview-png').addEventListener('click', ()=> downloadPNG(overviewChart,'overview.png'));
  document.getElementById('export-expense-png').addEventListener('click', ()=> downloadPNG(expenseChart,'expense-categories.png'));
  document.getElementById('export-income-png').addEventListener('click', ()=> downloadPNG(incomeChart,'income-by-category.png'));
  document.getElementById('export-overview-pdf').addEventListener('click', ()=> downloadPDF(overviewChart,'overview.pdf'));
  document.getElementById('export-expense-pdf').addEventListener('click', ()=> downloadPDF(expenseChart,'expense-categories.pdf'));
});
</script>
{% endblock %}
