{% extends 'base.html' %}
{% load static %}

{% block title %}AI Financial Agent{% endblock %}

{% block extra_css %}
<style>
    /* Layout */
    .agent-page { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
    .chat-shell { background: #0b1220; border-radius: 1rem; overflow: hidden; box-shadow: 0 8px 30px rgba(2,6,23,0.6); }

    /* Chat container */
    .chat-container { height: 64vh; border: 1px solid #273449; border-radius: 0.75rem; overflow-y: auto; padding: 1.25rem; background: linear-gradient(180deg,#0f1724,#0a1220); scrollbar-width: thin; scrollbar-color: #475569 #0a1220; }
    .chat-container::-webkit-scrollbar { width: 8px; }
    .chat-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 6px; }

    /* Message groups */
    .message-with-avatar { display:flex; gap:0.75rem; align-items:flex-start; margin-bottom:1rem; }
    .user-message-with-avatar { flex-direction:row-reverse; }

    .ai-avatar, .user-avatar { width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; color:#fff; font-weight:700; }
    .ai-avatar { background: linear-gradient(135deg,#065f46,#0ea5a0); }
    .user-avatar { background: linear-gradient(135deg,#1e40af,#2563eb); }
    .message-content { max-width: calc(85% - 4rem); padding:0.9rem 1rem; border-radius:0.9rem; font-size:0.95rem; line-height:1.4; box-shadow: 0 6px 16px rgba(2,6,23,0.6); }
    .agent-message-content { background:#071027; border:1px solid #1f2937; color:#e6f7f2; }
    .user-message-content { background: linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; text-align:right; }
    .message-meta { font-size:0.75rem; opacity:0.7; margin-top:0.5rem; font-family:'JetBrains Mono', monospace; }

    /* Quick actions */
    .quick-actions { display:flex; gap:0.75rem; flex-wrap:wrap; margin-bottom:1rem; }
    .quick-action { background:#062024; color:#a7f3d0; border-radius:14px; padding:0.5rem 0.9rem; cursor:pointer; border:1px solid #08323a; font-weight:600; display:inline-flex; gap:0.5rem; align-items:center; transition:transform .12s ease, box-shadow .12s ease; }
    .quick-action:hover, .quick-action:focus { transform:translateY(-3px); box-shadow:0 8px 24px rgba(2,6,23,0.6); outline:none; }
    .quick-action .label { color:#bfead4; }

    /* Input */
    .input-row { display:flex; gap:0.75rem; padding:0.9rem; background:#071428; border-top:1px solid #253046; align-items:center; }
    .message-input { flex:1; padding:0.75rem 1rem; border-radius:9999px; border:1px solid #203040; background:transparent; color:#e6eef6; outline:none; font-size:1rem; }
    .message-input::placeholder { color:#94a3b8; }
    .send-button { background: linear-gradient(135deg,#06b6d4,#2563eb); color:#022; border:none; padding:0.6rem 1rem; border-radius:9999px; font-weight:700; cursor:pointer; }
    .send-button:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

    /* Status & helper */
    .agent-status { padding:0.6rem 0.9rem; border-radius:10px; font-weight:600; font-size:0.95rem; }
    .status-healthy { background:#042f2a; border:1px solid #10b981; color:#a7f3d0; }
    .status-unhealthy { background:#3b0f0f; border:1px solid #ef4444; color:#fecaca; }

    /* Tool results */
    .tool-results { background:#042f1f; border-left:4px solid #10b981; color:#d1fae5; padding:0.6rem; border-radius:8px; margin-top:0.5rem; }

    /* Responsive */
    @media (max-width:640px) { .agent-page { padding:1rem; } .chat-container { height:56vh; padding:0.9rem; } .ai-avatar,.user-avatar{width:36px;height:36px} .message-content{font-size:0.92rem} }
</style>
{% endblock %}

{% block content %}
<div class="agent-page">
  <div class="mb-6 flex items-start justify-between">
    <div>
      <h1 class="text-3xl font-bold text-white">ü§ñ AI Financial Agent</h1>
      <p class="text-slate-400">Smart, finance-first assistant for summaries, forecasts, and currency tools.</p>
    </div>
    <div class="flex items-center gap-3">
      <div id="agent-status" class="agent-status">
        <div class="spinner"></div> Checking agent status...
      </div>
      <button class="quick-action tooltip" aria-label="Help" title="Help and tips for the AI Agent">
        ‚ùî<span class="sr-only">Help</span>
      </button>
    </div>
  </div>

  <div class="chat-shell">
    <div style="padding:1rem 1.25rem;">
      <div class="quick-actions">
        <button class="quick-action" onclick="sendQuickMessage('Show my financial summary for last month')">üìä <span class="label">Monthly Summary</span></button>
        <button class="quick-action" onclick="sendQuickMessage('What are my top expenses this month?')">üí∏ <span class="label">Top Expenses</span></button>
        <button class="quick-action" onclick="sendQuickMessage('Generate a forecast for next month')">üîÆ <span class="label">Forecast</span></button>
        <button class="quick-action" onclick="sendQuickMessage('Convert 1000 USD to EUR')">üí± <span class="label">Currency Convert</span></button>
      </div>
    </div>

    <div id="chat-container" class="chat-container">
      <!-- Initial system/agent greeting -->
      <div class="message-with-avatar">
        <div class="ai-avatar">AI</div>
        <div class="message-content agent-message-content">
          <div class="font-semibold text-green-300 mb-1">Hello ‚Äî I'm your AI Financial Agent</div>
          <div class="text-slate-300">I can help with: summaries, forecasts, currency conversion, category analysis, scheduling, and exportable reports. Try the quick actions above to get started.</div>
          <div class="message-meta">{{ "now"|date:"H:i" }}</div>
        </div>
      </div>
    </div>

    <div id="loading" class="loading" style="display:none;padding:0.8rem;text-align:center;color:#9ca3af">
      <div class="spinner"></div> AI Agent is thinking...
    </div>

    <div class="input-row">
      <input id="message-input" class="message-input" placeholder="Ask about your finances (e.g., 'Show last month summary')" aria-label="Message to AI agent" onkeypress="handleKeyPress(event)">
      <button id="send-button" class="send-button" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Keep existing helper functions and wire to new UI when possible
let isAgentResponding = false;

document.addEventListener('DOMContentLoaded', function() { checkAgentStatus(); });

async function checkAgentStatus() {
  try {
    const resp = await fetch('/api/health/');
    const data = await resp.json();
    const el = document.getElementById('agent-status');
    if (data.status === 'healthy') { el.className='agent-status status-healthy'; el.innerText='AI Agent is online'; } else { el.className='agent-status status-unhealthy'; el.innerText='AI Agent experiencing issues'; }
  } catch (e) { const el = document.getElementById('agent-status'); el.className='agent-status status-unhealthy'; el.innerText='Cannot reach AI Agent'; console.error(e); }
}

function handleKeyPress(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }

function sendQuickMessage(message) { document.getElementById('message-input').value = message; sendMessage(); }

async function sendMessage() {
  const input = document.getElementById('message-input');
  const message = input.value.trim();
  if (!message || isAgentResponding) return;
  addMessageToChat(message,'user');
  input.value=''; setAgentResponding(true);
  try {
    const resp = await fetch('/api/chat/',{ method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify({message}) });
    const data = await resp.json();
    if (resp.ok) { addMessageToChat(data.response,'agent', data.tool_results); } else { addMessageToChat('Error: '+(data.error||'Unknown'),'agent'); }
  } catch(err) { console.error(err); addMessageToChat('Network error. Try again.','agent'); } finally { setAgentResponding(false); }
}

function addMessageToChat(message, sender, toolResults=null) {
  const container = document.getElementById('chat-container');
  const wrapper = document.createElement('div');
  wrapper.className = 'message-with-avatar ' + (sender==='user'?'user-message-with-avatar':'');
  const avatar = document.createElement('div'); avatar.className = (sender==='user'?'user-avatar':'ai-avatar'); avatar.textContent = sender==='user'?'You':'AI';
  const content = document.createElement('div'); content.className = 'message-content ' + (sender==='user'?'user-message-content':'agent-message-content');
  if (sender==='agent') { const h = document.createElement('div'); h.className='font-semibold text-green-300 mb-1'; h.textContent='AI Financial Agent'; content.appendChild(h); }
  const body = document.createElement('div'); body.innerHTML = formatMessage(message); content.appendChild(body);
  if (toolResults && toolResults.length>0) { const tr = document.createElement('div'); tr.className='tool-results'; tr.innerHTML = '<strong>Actions:</strong> '+toolResults.length+' operation(s)'; content.appendChild(tr); }
  const meta = document.createElement('div'); meta.className='message-meta'; meta.textContent = new Date().toLocaleTimeString(); content.appendChild(meta);
  wrapper.appendChild(avatar); wrapper.appendChild(content); container.appendChild(wrapper); container.scrollTop = container.scrollHeight;
}

function formatMessage(message){ return message.replace(/\n/g,'<br>'); }
function setAgentResponding(v){ isAgentResponding=v; document.getElementById('send-button').disabled=v; document.getElementById('loading') && (document.getElementById('loading').style.display = v? 'block':'none'); document.getElementById('message-input').disabled=v; }
function getCookie(name){ let cookieValue=null; if(document.cookie && document.cookie!==''){ const cookies=document.cookie.split(';'); for(let i=0;i<cookies.length;i++){ const c=cookies[i].trim(); if(c.substring(0,name.length+1)===name+'='){ cookieValue=decodeURIComponent(c.substring(name.length+1)); break; } } } return cookieValue; }
</script>
{% endblock %}
